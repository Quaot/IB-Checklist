<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>IB Paper Checklist v24</title>
<style>
  body{font:14px "Segoe UI",sans-serif;background:#0f0f0f;color:#eee;margin:20px auto;max-width:1250px}
  h1{text-align:center;color:#7dd3fc;font-size:1.2em;margin:0 0 10px}

  #bar{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:10px;align-items:center}
  button,select,input[type=text],textarea{border:none;border-radius:8px;padding:7px 11px;font-size:13px}
  button{cursor:pointer;background:#3b82f6;color:#fff}
  button:hover{background:#60a5fa}
  #reset{background:#ef4444} #reset:hover{background:#f87171}
  #filtersBtn{background:#22c55e} #filtersBtn:hover{background:#4ade80}
  #rulesBtn{background:#a855f7} #rulesBtn:hover{background:#c084fc}
  input[type=text],textarea,select{background:#1a1a1a;color:#eee;outline:none}

  table{width:100%;border-collapse:collapse;font-size:13px;margin-top:8px}
  th,td{padding:5px 6px;border-bottom:1px solid #222;text-align:left;vertical-align:top}
  th{color:#50fa7b;font-weight:700}
  th.compact,td.compact{white-space:nowrap}
  td.compact{padding:4px 5px}

  a{color:#9ccaff;text-decoration:none}
  a:hover{text-decoration:underline}
  input[type=checkbox]{transform:scale(1.1)}

  .yearhead{background:#181818;font-weight:700;color:#9ee6a3}
  .hlMay{background:#0d3b66;} .slMay{background:#144d7e;}
  .hlNov{background:#7b341e;} .slNov{background:#a14d1c;}
  .otherRow{background:#1a1a1a;}

  .missingRow{background:#3a0a0a;color:#fff;}
  .doneRow{background:#070707 !important;color:#b7b7b7;}
  .doneRow a{color:#8aa6c7}
  tbody tr:hover td{background:#1b1b1b;}

  .paperCell{display:flex;flex-direction:column;gap:6px}
  .paperLine{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .pill{border:1px solid #2a2a2a;border-radius:999px;padding:2px 8px;font-size:12px;opacity:.95}
  .pill.qp{color:#c7d2fe}
  .pill.ms{color:#bbf7d0}
  .missTxt{color:#ff7676;font-weight:700}
  .small{opacity:.9;font-size:12px}

  /* Panels */
  .panelWrap{display:none;max-width:1220px;margin:0 auto 10px}
  .panel{
    background:#121212;border:1px solid #222;border-radius:12px;padding:12px;
    display:grid;grid-template-columns:repeat(3,minmax(260px,1fr));gap:10px
  }
  .group{background:#0f0f0f;border:1px solid #222;border-radius:10px;padding:10px}
  .group h3{margin:0 0 8px;font-size:13px;color:#e5e7eb}
  .checklist{display:flex;flex-direction:column;gap:6px;max-height:240px;overflow:auto;padding-right:6px}
  .item{display:flex;gap:8px;align-items:center}
  .item label{cursor:pointer}
  .footerRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
  .footerRow button{background:#334155}
  .footerRow button:hover{background:#475569}
  .note{font-size:12px;opacity:.85;line-height:1.35}
  .row2{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .row2 > *{flex:1;min-width:140px}
  textarea{width:100%;min-height:160px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .danger{background:#7f1d1d !important}
  .danger:hover{background:#991b1b !important}

  /* Preview pane (shows only on hover) */
  #previewPane{
    position:fixed;
    top:58px;
    right:0;
    width:42%;
    height:86%;
    background:#0b0b0b;
    border-left:1px solid #222;
    display:none;
    z-index:60;
  }
  #previewFrame{
    width:100%;
    height:100%;
    border:none;
  }
</style>
</head>
<body>

<h1>IB Paper Checklist</h1>

<div id="bar">
  <input type="text" id="search" placeholder="Search (year / session / tz / level / subject / file)" size="44">
  <button id="pick">Choose Folder</button>
  <button id="filtersBtn">Filters</button>
  <button id="rulesBtn">Missing Rules</button>

  <select id="missingMode">
    <option value="all" selected>Show: All</option>
    <option value="missingAny">Show: Missing anything</option>
    <option value="missingQP">Show: Missing QP</option>
    <option value="missingMS">Show: Missing MS</option>
  </select>

  <select id="sortMode">
    <option value="recent" selected>Sort: Most Recent</option>
    <option value="complete">Sort: Done First</option>
    <option value="incomplete">Sort: Undone First</option>
  </select>

  <button id="reset">Reset Progress</button>
</div>

<!-- Filters panel -->
<div id="filtersWrap" class="panelWrap">
  <div class="panel">

    <div class="group">
      <h3>Subjects</h3>
      <div class="checklist" id="subjectsList"></div>
      <div class="footerRow">
        <button id="subAll">Select All</button>
        <button id="subNone">Select None</button>
      </div>
      <div class="note">Filters start unselected. Select options (or Select All) to show rows.</div>
    </div>

    <div class="group">
      <h3>Levels</h3>
      <div class="checklist" id="levelsList"></div>
      <div class="footerRow">
        <button id="lvlAll">Select All</button>
        <button id="lvlNone">Select None</button>
      </div>
    </div>

    <div class="group">
      <h3>Papers</h3>
      <div class="checklist" id="papersList"></div>
      <div class="footerRow">
        <button id="papAll">Select All</button>
        <button id="papNone">Select None</button>
      </div>
      <div class="note">P1a/P1b are only expected for sciences when enabled in Missing Rules.</div>
    </div>

    <div class="group">
      <h3>Session</h3>
      <div class="checklist" id="sessionsList"></div>
      <div class="footerRow">
        <button id="sesAll">Select All</button>
        <button id="sesNone">Select None</button>
      </div>
    </div>

    <div class="group">
      <h3>Timezone</h3>
      <div class="checklist" id="tzList"></div>
      <div class="footerRow">
        <button id="tzAll">Select All</button>
        <button id="tzNone">Select None</button>
      </div>
      <div class="note">Expected timezones: Nov 2025 has 3; other Nov years have 2; May has 3.</div>
    </div>

    <div class="group">
      <h3>Status</h3>
      <div class="checklist" id="statusList"></div>
      <div class="note" style="margin-top:8px">Done darkens the entire row.</div>
    </div>

  </div>
</div>

<!-- Missing rules editor -->
<div id="rulesWrap" class="panelWrap">
  <div class="panel">

    <div class="group" style="grid-column:1 / -1">
      <h3>Missing Rules Editor</h3>
      <div class="note">
        Rules control what is expected. If something is not expected, it will not appear as missing.
        You can disable many subjects/papers/years/timezones at once. You can also enable P1a/P1b for sciences.
      </div>
    </div>

    <div class="group">
      <h3>Create Rule</h3>

      <div class="row2">
        <select id="ruleType">
          <option value="disable">Disable (not expected)</option>
          <option value="enableP1ab">Enable P1a/P1b for sciences</option>
        </select>

        <select id="ruleYearsMode">
          <option value="selected" selected>Years: selected</option>
          <option value="all">Years: all</option>
        </select>
      </div>

      <div class="note" style="margin:8px 0 6px">Select multiple values. Leave a section empty to mean “any”.</div>

      <div class="row2">
        <div>
          <div class="small">Subjects</div>
          <div class="checklist" id="ruleSubjects"></div>
          <div class="footerRow">
            <button id="rsAll">All</button><button id="rsNone">None</button>
          </div>
        </div>

        <div>
          <div class="small">Papers</div>
          <div class="checklist" id="rulePapers"></div>
          <div class="footerRow">
            <button id="rpAll">All</button><button id="rpNone">None</button>
          </div>
        </div>

        <div>
          <div class="small">Years</div>
          <div class="checklist" id="ruleYears"></div>
          <div class="footerRow">
            <button id="ryAll">All</button><button id="ryNone">None</button>
          </div>
        </div>
      </div>

      <div class="row2" style="margin-top:10px">
        <div>
          <div class="small">Session</div>
          <div class="checklist" id="ruleSessions"></div>
        </div>
        <div>
          <div class="small">Level</div>
          <div class="checklist" id="ruleLevels"></div>
        </div>
        <div>
          <div class="small">Timezone</div>
          <div class="checklist" id="ruleTZ"></div>
        </div>
      </div>

      <div class="footerRow">
        <button id="addRule">Add Rule</button>
        <button id="clearRules" class="danger">Clear All Rules</button>
      </div>

      <div class="note" style="margin-top:8px">
        Examples:
        <br>- Disable P3 for Mandarin + English: select subjects MB and EN, select paper P3, add rule.
        <br>- Disable TZ2+TZ3 for multiple years: select tz 2 and 3, select years, add rule.
        <br>- Enable P1a/P1b for Physics: choose enable type, select PH, select years, add rule.
      </div>
    </div>

    <div class="group">
      <h3>Current Rules</h3>
      <div id="rulesList" class="checklist"></div>
    </div>

    <div class="group">
      <h3>Export / Import Rules</h3>
      <div class="note">Copy JSON to keep your setup, or paste JSON to restore it.</div>
      <textarea id="rulesJson"></textarea>
      <div class="footerRow">
        <button id="refreshJson">Refresh Export</button>
        <button id="importJson">Import JSON</button>
      </div>
    </div>

  </div>
</div>

<table id="tbl">
<thead>
<tr>
  <th class="compact" style="width:70px">Year</th>
  <th class="compact" style="width:70px">Session</th>
  <th class="compact" style="width:140px">Subject</th>
  <th class="compact" style="width:55px">Level</th>
  <th class="compact" style="width:45px">TZ</th>
  <th>Paper + Markscheme</th>
</tr>
</thead>
<tbody></tbody>
</table>

<!-- Preview pane (hover-only) -->
<div id="previewPane">
  <iframe id="previewFrame"></iframe>
</div>

<script>
window.addEventListener("DOMContentLoaded",()=>{

/* ===== SUBJECT CODES MUST MATCH YOUR RENAMER ===== */
const SUBJECTS = [
  {code:"CH", name:"Chemistry"},
  {code:"EC", name:"Economics"},
  {code:"EN", name:"English Lit A"},
  {code:"GE", name:"Geography"},
  {code:"KO", name:"Korean A"},
  {code:"MB", name:"Mandarin B"},
  {code:"MA", name:"Math"},
  {code:"PH", name:"Physics"},
  {code:"SP", name:"Spanish AB"},
];

const SCIENCE_SUBJECTS = new Set(["PH","CH","BI"]); // add "BI" if you have Biology codes

const PAPER_OPTIONS = ["P1","P1a","P1b","P2","P3"];
const LEVEL_OPTIONS = ["HL","SL"];
const SESSION_OPTIONS = ["May","Nov"];
const TZ_OPTIONS = ["1","2","3","none"];

/* Default year range */
const expectedYears = Array.from({length:10},(_,i)=>2016+i);

/* ===== Expected timezone assumptions (as requested) =====
   - Nov 2025: 3 timezones
   - Other Nov years: 2 timezones
   - May: 3 timezones
*/
function tzList(year, session){
  if(session==="Nov"){
    return year===2025 ? [1,2,3] : [1,2];
  }
  return [1,2,3];
}

/* ===== Expected papers:
   - Default: P1, P2, P3 for all subjects
   - P1a/P1b only for sciences AND only when enabled via rules
*/
function basePapers(){
  return ["P1","P2","P3"];
}

/* ===== Storage ===== */
const doneKey  = "ib_checklist_v24_done";
const rulesKey = "ib_checklist_v24_rules";

/* ===== State ===== */
let done = JSON.parse(localStorage.getItem(doneKey)||"{}");
let currentFiles = [];
const tbody = document.querySelector("#tbl tbody");

const filtersWrap = document.getElementById("filtersWrap");
const rulesWrap = document.getElementById("rulesWrap");

/* Filters start UNSELECTED (your request) */
let filters = {
  subjects: new Set(),
  levels: new Set(),
  papers: new Set(),
  sessions: new Set(),
  tz: new Set(),
  status: "all"
};

/* Rules: two types
   1) disable: {type:"disable", subjects?:[], papers?:[], years?:[], sessions?:[], levels?:[], tz?:[]}
   2) enableP1ab: {type:"enableP1ab", subjects?:[], years?:[]}
*/
let rules = loadRules();

/* Default rules example: disable all of 2020 (so 2020 won't show as missing) */
if(rules.length===0){
  rules = [
    {type:"disable", years:[2020]}  // "no papers in 2020"
  ];
  saveRules();
}

/* ===== URL cache for previews ===== */
const urlCache = new Map(); // key: File object -> objectURL
function getUrl(file){
  if(urlCache.has(file)) return urlCache.get(file);
  const url = URL.createObjectURL(file);
  urlCache.set(file, url);
  return url;
}

/* ===== Parse new filename scheme ===== */
function parseMeta(filename){
  // (MS-)?<SUB>-<YY><M/N>-P<1|2|3><a|b optional>-<TZ optional>-<HL|SL>.pdf
  const m=/^(MS-)?([A-Z]{2})-(\d{2})([MN])-P([123])([ab])?(?:-([123]))?-(HL|SL)\.pdf$/i.exec(filename);
  if(!m) return null;

  const isMS=!!m[1];
  const sub=m[2].toUpperCase();
  const yy=+m[3];
  const year=2000+yy;
  const sess=m[4].toUpperCase(); // M/N
  const pnum=m[5];
  const variant=m[6] ? m[6].toLowerCase() : "";
  const tz=m[7] ? String(m[7]) : "none";
  const level=m[8].toUpperCase();

  const subj = SUBJECTS.find(s=>s.code===sub);
  const subjectName = subj ? subj.name : sub;

  return{
    filename,
    isMS,
    subjectCode: sub,
    subjectName,
    year,
    session: sess==="M" ? "May" : "Nov",
    sessionCode: sess,
    level,
    tz,
    paperLabel: `P${pnum}${variant}`,
  };
}

function baseId(meta){
  return `${meta.subjectCode}-${meta.year}-${meta.sessionCode}-${meta.level}-${meta.paperLabel}-${meta.tz}`;
}

/* ===== Row colouring ===== */
function colour(level,session){
  if(session==="May"&&level==="HL")return"hlMay";
  if(session==="May"&&level==="SL")return"slMay";
  if(session==="Nov"&&level==="HL")return"hlNov";
  if(session==="Nov"&&level==="SL")return"slNov";
  return"otherRow";
}

/* ===== Rules engine ===== */
function loadRules(){
  try{
    const v = JSON.parse(localStorage.getItem(rulesKey) || "[]");
    return Array.isArray(v) ? v : [];
  }catch{ return []; }
}
function saveRules(){
  localStorage.setItem(rulesKey, JSON.stringify(rules));
}

function matchesRule(rule, meta){
  if(rule.subjects && !rule.subjects.includes(meta.subjectCode)) return false;
  if(rule.papers && !rule.papers.includes(meta.paperLabel)) return false;
  if(rule.years && !rule.years.includes(meta.year)) return false;
  if(rule.sessions && !rule.sessions.includes(meta.sessionCode)) return false;
  if(rule.levels && !rule.levels.includes(meta.level)) return false;
  if(rule.tz && !rule.tz.includes(meta.tz)) return false;
  return true;
}

function isExpected(meta){
  // if any disable rule matches -> not expected
  for(const r of rules){
    if(r.type==="disable" && matchesRule(r, meta)) return false;
  }
  return true;
}

function p1abEnabledFor(subjectCode, year){
  // P1a/P1b are enabled if there exists an enableP1ab rule that matches subject/year.
  for(const r of rules){
    if(r.type!=="enableP1ab") continue;

    const subOk = !r.subjects || r.subjects.length===0 || r.subjects.includes(subjectCode);
    const yrOk  = !r.years || r.years.length===0 || r.years.includes(year);

    if(subOk && yrOk) return true;
  }
  return false;
}

/* ===== Expected grid generation (minimal, not "everything") ===== */
function generateExpected(){
  const out=[];
  for(const year of expectedYears){
    for(const session of ["May","Nov"]){
      const sessionCode = session==="May" ? "M" : "N";
      for(const level of LEVEL_OPTIONS){
        for(const tz of tzList(year, session)){
          for(const subject of SUBJECTS){
            // Always expect P1/P2/P3, then optionally add P1a/P1b for sciences if enabled.
            const papers = basePapers().slice();

            if(SCIENCE_SUBJECTS.has(subject.code) && p1abEnabledFor(subject.code, year)){
              papers.push("P1a","P1b");
            }

            for(const paper of papers){
              const meta = {
                subjectCode: subject.code,
                subjectName: subject.name,
                year,
                session,
                sessionCode,
                level,
                tz: String(tz),
                paperLabel: paper
              };
              if(isExpected(meta)) out.push(meta);
            }
          }
        }
      }
    }
  }
  return out;
}

/* ===== Filters ===== */
function passesFilters(meta, isDone, hasQP, hasMS){
  // IMPORTANT: if a group is empty, show NOTHING (this prevents “load everything”)
  if(filters.subjects.size===0) return false;
  if(filters.levels.size===0) return false;
  if(filters.papers.size===0) return false;
  if(filters.sessions.size===0) return false;
  if(filters.tz.size===0) return false;

  if(!filters.subjects.has(meta.subjectCode)) return false;
  if(!filters.levels.has(meta.level)) return false;
  if(!filters.papers.has(meta.paperLabel)) return false;
  if(!filters.sessions.has(meta.session)) return false;
  if(!filters.tz.has(meta.tz)) return false;

  if(filters.status==="done" && !isDone) return false;
  if(filters.status==="undone" && isDone) return false;

  const missingMode=document.getElementById("missingMode").value;
  if(missingMode==="missingAny" && (hasQP && hasMS)) return false;
  if(missingMode==="missingQP" && hasQP) return false;
  if(missingMode==="missingMS" && hasMS) return false;

  return true;
}

/* ===== File picker ===== */
async function gatherFilesRecursively(dirHandle, files){
  for await(const entry of dirHandle.values()){
    if(entry.kind==="file" && entry.name.toLowerCase().endsWith(".pdf")){
      try{ files.push(await entry.getFile()); } catch {}
    } else if(entry.kind==="directory"){
      await gatherFilesRecursively(entry, files);
    }
  }
}
async function pickBase(){
  try{
    const base=await showDirectoryPicker();
    const files=[];
    await gatherFilesRecursively(base,files);
    currentFiles=files;
    render();
  }catch(e){
    alert(e.name+": "+e.message);
  }
}

/* ===== Preview pane hover behavior ===== */
let hideTimer=null;
function showPreview(url){
  const pane=document.getElementById("previewPane");
  const frame=document.getElementById("previewFrame");
  frame.src = url;
  pane.style.display="block";
}
function hidePreviewSoon(){
  if(hideTimer) clearTimeout(hideTimer);
  hideTimer=setTimeout(()=>{
    document.getElementById("previewPane").style.display="none";
  }, 150);
}
function cancelHide(){
  if(hideTimer) clearTimeout(hideTimer);
}

document.getElementById("previewPane").addEventListener("mouseenter", cancelHide);
document.getElementById("previewPane").addEventListener("mouseleave", hidePreviewSoon);

function attachPreviewHandlers(tr){
  tr.querySelectorAll("a[data-preview]").forEach(a=>{
    a.addEventListener("mouseenter", ()=>{
      cancelHide();
      showPreview(a.dataset.preview);
    });
    a.addEventListener("mouseleave", hidePreviewSoon);
  });
}

/* ===== Rendering ===== */
function render(){
  const search=document.getElementById("search").value.toLowerCase();
  const sortMode=document.getElementById("sortMode").value;

  tbody.innerHTML="";
  if(!currentFiles.length) return;

  // index actual files
  const parsed=currentFiles
    .map(f=>({meta:parseMeta(f.name), file:f}))
    .filter(x=>x.meta);

  const mapQP=new Map();
  const mapMS=new Map();
  parsed.forEach(x=>{
    const id=baseId(x.meta);
    if(x.meta.isMS) mapMS.set(id,x);
    else mapQP.set(id,x);
  });

  const expected = generateExpected();

  let rows=[];
  for(const meta of expected){
    const id=baseId(meta);
    const qp=mapQP.get(id);
    const ms=mapMS.get(id);
    const hasQP=!!qp;
    const hasMS=!!ms;
    const isDone=!!done[id];
    const missing = (!hasQP || !hasMS);

    if(!passesFilters(meta, isDone, hasQP, hasMS)) continue;

    const searchTarget = (
      `${meta.subjectCode} ${meta.subjectName} ${meta.year} ${meta.session} ${meta.level} ` +
      `${meta.paperLabel} tz${meta.tz} ` +
      `${qp?.file.name ?? ""} ${ms?.file.name ?? ""}`
    ).toLowerCase();
    if(search && !searchTarget.includes(search)) continue;

    const qpLine = hasQP
      ? (()=>{ const url=getUrl(qp.file); return `<a href="${url}" target="_blank" data-preview="${url}">${qp.file.name}</a>`; })()
      : `<span class="missTxt">Missing</span>`;

    const msLine = hasMS
      ? (()=>{ const url=getUrl(ms.file); return `<a href="${url}" target="_blank" data-preview="${url}">${ms.file.name}</a>`; })()
      : `<span class="missTxt">Missing</span>`;

    const rowClass = (isDone ? "doneRow" : colour(meta.level, meta.session)) + (missing && !isDone ? " missingRow" : "");

    rows.push({
      meta, id, isDone,
      rowClass,
      html: `
        <td class="compact">${meta.year}</td>
        <td class="compact">${meta.session}</td>
        <td class="compact">${meta.subjectName}</td>
        <td class="compact">${meta.level}</td>
        <td class="compact">${meta.tz==="none" ? "" : meta.tz}</td>
        <td>
          <div class="paperCell">
            <div class="paperLine">
              <span class="pill qp">${meta.paperLabel}</span>
              ${qpLine}
              <label class="small">
                <input type="checkbox" data-id="${id}" ${isDone?"checked":""}>
                Done
              </label>
            </div>
            <div class="paperLine">
              <span class="pill ms">MS</span>
              ${msLine}
            </div>
          </div>
        </td>
      `
    });
  }

  // sort
  rows.sort((a,b)=>{
    if(sortMode==="recent"){
      if(a.meta.year!==b.meta.year) return b.meta.year-a.meta.year;
      if(a.meta.session!==b.meta.session) return a.meta.session==="May"?-1:1;
      if(a.meta.subjectCode!==b.meta.subjectCode) return a.meta.subjectCode.localeCompare(b.meta.subjectCode);
      if(a.meta.level!==b.meta.level) return a.meta.level.localeCompare(b.meta.level);
      if(a.meta.paperLabel!==b.meta.paperLabel) return a.meta.paperLabel.localeCompare(b.meta.paperLabel);
      const atz = a.meta.tz==="none" ? 99 : +a.meta.tz;
      const btz = b.meta.tz==="none" ? 99 : +b.meta.tz;
      return atz-btz;
    }else if(sortMode==="complete"){
      return (b.isDone?1:0)-(a.isDone?1:0);
    }else if(sortMode==="incomplete"){
      return (a.isDone?1:0)-(b.isDone?1:0);
    }
    return 0;
  });

  // group by year
  const grouped={};
  for(const r of rows){
    if(!grouped[r.meta.year]) grouped[r.meta.year]=[];
    grouped[r.meta.year].push(r);
  }

  Object.keys(grouped).sort((a,b)=>b-a).forEach(year=>{
    const head=document.createElement("tr");
    head.innerHTML=`<td colspan="6" class="yearhead">${year}</td>`;
    tbody.appendChild(head);

    grouped[year].forEach(r=>{
      const tr=document.createElement("tr");
      tr.className=r.rowClass;
      tr.innerHTML=r.html;

      // Done checkbox
      const box=tr.querySelector('input[type="checkbox"][data-id]');
      box.onchange=(e)=>{
        done[r.id]=e.target.checked;
        localStorage.setItem(doneKey, JSON.stringify(done));
        render();
      };

      // Preview hover
      attachPreviewHandlers(tr);

      tbody.appendChild(tr);
    });
  });
}

/* ===== Filters UI ===== */
function makeChecklist(containerId, options, setRef, onChange, labelFn){
  const el=document.getElementById(containerId);
  el.innerHTML="";
  options.forEach(opt=>{
    const id=`${containerId}_${String(opt).replace(/\s+/g,'_')}`;
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML=`
      <input type="checkbox" id="${id}" ${setRef.has(opt) ? "checked" : ""}>
      <label for="${id}">${labelFn ? labelFn(opt) : opt}</label>
    `;
    const box=div.querySelector("input");
    box.onchange=()=>onChange(opt, box.checked);
    el.appendChild(div);
  });
}
function setAll(setRef, options){ setRef.clear(); options.forEach(o=>setRef.add(o)); }
function setNone(setRef){ setRef.clear(); }

function initFilters(){
  makeChecklist("subjectsList", SUBJECTS.map(s=>s.code), filters.subjects, (opt,checked)=>{
    checked ? filters.subjects.add(opt) : filters.subjects.delete(opt);
    render();
  }, code => {
    const s=SUBJECTS.find(x=>x.code===code);
    return `${s ? s.name : code} (${code})`;
  });

  makeChecklist("levelsList", LEVEL_OPTIONS, filters.levels, (opt,checked)=>{
    checked ? filters.levels.add(opt) : filters.levels.delete(opt);
    render();
  });

  makeChecklist("papersList", PAPER_OPTIONS, filters.papers, (opt,checked)=>{
    checked ? filters.papers.add(opt) : filters.papers.delete(opt);
    render();
  });

  makeChecklist("sessionsList", SESSION_OPTIONS, filters.sessions, (opt,checked)=>{
    checked ? filters.sessions.add(opt) : filters.sessions.delete(opt);
    render();
  });

  makeChecklist("tzList", TZ_OPTIONS, filters.tz, (opt,checked)=>{
    checked ? filters.tz.add(opt) : filters.tz.delete(opt);
    render();
  }, opt => opt==="none" ? "No TZ" : `TZ ${opt}`);

  // status radios
  const statusEl=document.getElementById("statusList");
  statusEl.innerHTML="";
  const opts=[{k:"all",t:"All"},{k:"done",t:"Done"},{k:"undone",t:"Undone"}];
  opts.forEach(o=>{
    const id=`status_${o.k}`;
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML=`
      <input type="radio" name="status" id="${id}" ${filters.status===o.k?"checked":""}>
      <label for="${id}">${o.t}</label>
    `;
    div.querySelector("input").onchange=()=>{filters.status=o.k; render();};
    statusEl.appendChild(div);
  });

  // bulk buttons
  document.getElementById("subAll").onclick=()=>{setAll(filters.subjects, SUBJECTS.map(s=>s.code)); initFilters(); render();};
  document.getElementById("subNone").onclick=()=>{setNone(filters.subjects); initFilters(); render();};

  document.getElementById("lvlAll").onclick=()=>{setAll(filters.levels, LEVEL_OPTIONS); initFilters(); render();};
  document.getElementById("lvlNone").onclick=()=>{setNone(filters.levels); initFilters(); render();};

  document.getElementById("papAll").onclick=()=>{setAll(filters.papers, PAPER_OPTIONS); initFilters(); render();};
  document.getElementById("papNone").onclick=()=>{setNone(filters.papers); initFilters(); render();};

  document.getElementById("sesAll").onclick=()=>{setAll(filters.sessions, SESSION_OPTIONS); initFilters(); render();};
  document.getElementById("sesNone").onclick=()=>{setNone(filters.sessions); initFilters(); render();};

  document.getElementById("tzAll").onclick=()=>{setAll(filters.tz, TZ_OPTIONS); initFilters(); render();};
  document.getElementById("tzNone").onclick=()=>{setNone(filters.tz); initFilters(); render();};
}

/* ===== Rules UI ===== */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
function ruleToText(r){
  if(r.type==="disable"){
    const parts=["Disable"];
    if(r.subjects?.length) parts.push(`subjects=${r.subjects.join(",")}`);
    if(r.papers?.length)   parts.push(`papers=${r.papers.join(",")}`);
    if(r.years?.length)    parts.push(`years=${r.years.join(",")}`);
    if(r.sessions?.length) parts.push(`sessions=${r.sessions.join(",")}`);
    if(r.levels?.length)   parts.push(`levels=${r.levels.join(",")}`);
    if(r.tz?.length)       parts.push(`tz=${r.tz.join(",")}`);
    if(parts.length===1) parts.push("(nothing selected)");
    return parts.join(" ");
  }
  if(r.type==="enableP1ab"){
    const parts=["Enable P1a/P1b (sciences)"];
    if(r.subjects?.length) parts.push(`subjects=${r.subjects.join(",")}`);
    if(r.years?.length)    parts.push(`years=${r.years.join(",")}`);
    return parts.join(" ");
  }
  return JSON.stringify(r);
}

function initRulesUI(){
  // multi-select sets for building a rule
  const sel = {
    subjects: new Set(),
    papers: new Set(),
    years: new Set(),
    sessions: new Set(),
    levels: new Set(),
    tz: new Set()
  };

  function buildMulti(containerId, options, setRef){
    makeChecklist(containerId, options, setRef, (opt,checked)=>{
      checked ? setRef.add(opt) : setRef.delete(opt);
    });
  }

  buildMulti("ruleSubjects", SUBJECTS.map(s=>s.code), sel.subjects);
  buildMulti("rulePapers", PAPER_OPTIONS, sel.papers);
  buildMulti("ruleYears", expectedYears, sel.years);
  buildMulti("ruleSessions", ["M","N"], sel.sessions, );
  // rewrite sessions/levels/tz with labels:
  makeChecklist("ruleSessions", ["M","N"], sel.sessions, (opt,checked)=>{
    checked ? sel.sessions.add(opt) : sel.sessions.delete(opt);
  }, opt => opt==="M" ? "May" : "Nov");

  makeChecklist("ruleLevels", LEVEL_OPTIONS, sel.levels, (opt,checked)=>{
    checked ? sel.levels.add(opt) : sel.levels.delete(opt);
  });

  makeChecklist("ruleTZ", ["1","2","3","none"], sel.tz, (opt,checked)=>{
    checked ? sel.tz.add(opt) : sel.tz.delete(opt);
  }, opt => opt==="none" ? "No TZ" : `TZ ${opt}`);

  // bulk buttons for subjects/papers/years
  document.getElementById("rsAll").onclick=()=>{ setAll(sel.subjects, SUBJECTS.map(s=>s.code)); initRulesUI(); };
  document.getElementById("rsNone").onclick=()=>{ setNone(sel.subjects); initRulesUI(); };
  document.getElementById("rpAll").onclick=()=>{ setAll(sel.papers, PAPER_OPTIONS); initRulesUI(); };
  document.getElementById("rpNone").onclick=()=>{ setNone(sel.papers); initRulesUI(); };
  document.getElementById("ryAll").onclick=()=>{ setAll(sel.years, expectedYears); initRulesUI(); };
  document.getElementById("ryNone").onclick=()=>{ setNone(sel.years); initRulesUI(); };

  function refreshRulesList(){
    const el=document.getElementById("rulesList");
    el.innerHTML="";
    rules.forEach((r,idx)=>{
      const div=document.createElement("div");
      div.className="item";
      div.style.justifyContent="space-between";
      div.innerHTML=`
        <span class="small">${escapeHtml(ruleToText(r))}</span>
        <button data-i="${idx}" style="padding:4px 10px;border-radius:8px;background:#334155">Remove</button>
      `;
      div.querySelector("button").onclick=(e)=>{
        const i=+e.target.dataset.i;
        rules.splice(i,1);
        saveRules();
        refreshRulesList();
        refreshExport();
        render();
      };
      el.appendChild(div);
    });
  }

  function refreshExport(){
    document.getElementById("rulesJson").value = JSON.stringify(rules, null, 2);
  }

  document.getElementById("addRule").onclick=()=>{
    const type=document.getElementById("ruleType").value;
    const yearsMode=document.getElementById("ruleYearsMode").value;

    const years = (yearsMode==="all") ? [] : [...sel.years].map(Number);

    if(type==="disable"){
      const rule = {type:"disable"};
      if(sel.subjects.size) rule.subjects=[...sel.subjects];
      if(sel.papers.size)   rule.papers=[...sel.papers];
      if(years.length)      rule.years=years;
      if(sel.sessions.size) rule.sessions=[...sel.sessions];
      if(sel.levels.size)   rule.levels=[...sel.levels];
      if(sel.tz.size)       rule.tz=[...sel.tz];
      rules.push(rule);
    }

    if(type==="enableP1ab"){
      const rule = {type:"enableP1ab"};
      if(sel.subjects.size) rule.subjects=[...sel.subjects];
      if(years.length)      rule.years=years;
      rules.push(rule);
    }

    saveRules();
    refreshRulesList();
    refreshExport();
    render();
  };

  document.getElementById("clearRules").onclick=()=>{
    if(!confirm("Clear all rules?")) return;
    rules=[];
    saveRules();
    refreshRulesList();
    refreshExport();
    render();
  };

  document.getElementById("refreshJson").onclick=()=>refreshExport();
  document.getElementById("importJson").onclick=()=>{
    try{
      const txt=document.getElementById("rulesJson").value;
      const obj=JSON.parse(txt);
      if(!Array.isArray(obj)) throw new Error("JSON must be an array");
      rules=obj;
      saveRules();
      refreshRulesList();
      refreshExport();
      render();
    }catch(e){
      alert("Import failed: " + e.message);
    }
  };

  refreshRulesList();
  refreshExport();
}

/* ===== Wire up buttons ===== */
document.getElementById("pick").onclick=pickBase;

document.getElementById("filtersBtn").onclick=()=>{
  filtersWrap.style.display = (filtersWrap.style.display==="block") ? "none" : "block";
};

document.getElementById("rulesBtn").onclick=()=>{
  rulesWrap.style.display = (rulesWrap.style.display==="block") ? "none" : "block";
};

document.getElementById("search").oninput=render;
document.getElementById("sortMode").oninput=render;
document.getElementById("missingMode").oninput=render;

document.getElementById("reset").onclick=()=>{
  if(!confirm("Clear saved progress?")) return;
  localStorage.removeItem(doneKey);
  done={};
  render();
};

/* ===== Init ===== */
initFilters();
initRulesUI();

});
</script>

</body>
</html>
